name: AI News Briefing Pipeline

on:
  # Scheduled run (adjust schedule based on your frequency setting)
  schedule:
    - cron: '0 9 * * 1'  # Monday at 9 AM UTC (for weekly briefings)
    # For daily briefings, use: '0 9 * * *'

  # Allow manual triggering
  workflow_dispatch:

jobs:
  run-briefing-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create config from template
        env:
          CONFIG_YAML: ${{ secrets.CONFIG_YAML }}
        run: |
          if [ -n "$CONFIG_YAML" ]; then
            echo "$CONFIG_YAML" > config/config.yaml
            echo "âœ“ Config loaded from secret"
          else
            echo "âš ï¸  CONFIG_YAML secret not set, using example"
            cp config/config.yaml.example config/config.yaml
          fi
          echo "ðŸ“‹ Checking email config..."
          python3 -c "import yaml; c=yaml.safe_load(open('config/config.yaml')); print(f\"email.enabled: {c.get('email', {}).get('enabled', 'NOT FOUND')}\")"
          python3 -c "import yaml; c=yaml.safe_load(open('config/config.yaml')); print(f\"email.recipient_email: {c.get('email', {}).get('recipient_email', 'NOT FOUND')}\")"

      - name: Set up Gmail credentials
        env:
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          mkdir -p .credentials
          echo "$GMAIL_CREDENTIALS" | base64 -d > .credentials/gmail_credentials.json
          echo "$GMAIL_TOKEN" | base64 -d > .credentials/gmail_token.json
          echo "âœ“ Gmail credentials configured"

      - name: Create .env file
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "OPENAI_API_KEY=$OPENAI_API_KEY" > .env
          echo "âœ“ Environment configured"

      - name: Run complete pipeline
        run: |
          python briefing_pipeline.py
          echo "âœ“ Pipeline complete!"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: briefing-logs
          path: logs/
          retention-days: 30
